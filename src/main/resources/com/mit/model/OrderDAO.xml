<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.mit.model.OrderDAO">
	<select id="getCompany" resultType="com.mit.model.CompanyDTO">
		SELECT DISTINCT ct.code AS companyCode
			, (SELECT cp.name FROM company cp WHERE cp.code = ct.code) AS companyName
		FROM tbl_contract ct
	</select>
	
	<select id="getOrderByMonth" resultType="com.mit.model.OrderDTO">
		SELECT p.order_num AS orderNum
			, p.order_date AS orderDate
			, (SELECT pt.partname FROM tbl_part pt WHERE pt.partcode = ct.partcode) AS partName
			, (SELECT cp.name FROM company cp WHERE cp.code = ct.code) AS companyName
			, ct.code AS companyCode
		FROM purchase_order p INNER JOIN tbl_contract ct ON p.contract_num = ct.contractno
		<![CDATA[
			WHERE #{ date } <= p.order_date AND p.order_date <= LAST_DAY(#{ date })
			ORDER BY p.order_date DESC
		]]>
	</select>
	
	<select id="getOrderInfo" resultType="com.mit.model.OrderDTO">
		SELECT e.empl_name AS emplName
			, e.empl_email AS email
			, cp.name AS companyName
			, cp.owner AS charge
			, cp.contact AS contact
			, cp.business_number AS businessNumber
			, p.order_date AS orderDate
			, p.due_date AS dueDate
			, ct.unitprice AS unitPrice
			, (SELECT pt.partname FROM tbl_part pt WHERE pt.partcode = ct.partcode) AS partName
			, p.order_quantity AS orderQuantity
			, cp.account AS account
			, cp.currency AS currency
		FROM purchase_order p INNER JOIN tbl_contract ct ON p.contract_num = ct.contractno
			INNER JOIN company cp ON ct.code = cp.code
			INNER JOIN employee e ON e.empl_num = p.empl_num
		WHERE cp.code = #{ companyCode } AND p.order_date = #{ orderDate }
	</select>
	
	<select id="searchOrderProgress" resultType="com.mit.model.OrderDTO">
		SELECT pt.partname AS partName
		    , e.empl_name AS emplName
		    , e.empl_email AS email
		    , cp.name AS companyName
		    , p.order_date AS orderDate
		    , p.due_date AS dueDate
		    , p.order_quantity AS orderQuantity
		    , NVL((SELECT SUM(i.inspection_quantity) AS completeQuantity FROM inspection i 
                WHERE (i.order_num, i.inspection_num) 
                    IN (SELECT ir.order_num, ir.inspection_num FROM inspection_result ir WHERE i.order_num = ir.order_num AND i.inspection_num = ir.inspection_num)), 0) AS completeQuantity
		FROM purchase_order p INNER JOIN employee e ON p.empl_num = e.empl_num
		    INNER JOIN tbl_contract ct ON p.contract_num = ct.contractno
		    INNER JOIN tbl_part pt ON ct.partcode = pt.partcode
		    INNER JOIN company cp ON ct.code = cp.code

		    
	    <where>
	    	<trim prefixOverrides="AND">
		    	<choose>
		    		<when test="partName != null">
			    		<![CDATA[
			    			AND pt.partname LIKE '%'||#{ partName }||'%'
		    			]]>
		    		</when>
		    		<when test="emplName != null">
			    		<![CDATA[
			    			AND e.emplName LIKE '%'||#{ emplName }||'%'
		    			]]>
		    		</when>
		    		<when test="companyName != null">
			    		<![CDATA[
			    			AND cp.companyName LIKE '%'||#{ companyName }||'%'
	    				]]>
		    		</when>
		    		<when test="initialOrderDate != null and finalOrderDate != null">
		    			<![CDATA[
		    				AND #{ initialOrderDate } < p.order_date AND p.order_date < #{ finalOrderDate }
		    			]]>
		    		</when>
		    		<when test="initialOrderDate == null and finalOrderDate != null">
		    			<![CDATA[
		    				AND sysdate < p.order_date AND p.order_date < #{ finalOrderDate }
		    			]]>
		    		</when>
		    		<when test="initialOrderDate != null and finalOrderDate == null">
		    			<![CDATA[
		    				AND sysdate < p.order_date AND p.order_date < sysdate
		    			]]>
		    		</when>
		    		<when test="initialDueDate != null and finalDueDate != null">
		    			<![CDATA[
		    				AND #{ initialDueDate } < p.due_date AND p.due_date < #{ finalDueDate }
		    			]]>
		    		</when>
		    		<when test="initialDueDate == null and finalDueDate != null">
		    			<![CDATA[
		    				AND sysdate < p.due_date AND p.due_date < #{ finalDueDate }
		    			]]>
		    		</when>
		    		<when test="initialDueDate != null and finalDueDate == null">
		    			<![CDATA[
		    				AND #{ initialDueDate } < p.due_date AND p.due_date < sysdate
		    			]]>
		    		</when>
		    	</choose>
	    	</trim>
	    </where>
	</select>
</mapper>