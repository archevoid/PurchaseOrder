<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.mit.model.PlanDAO">
	<select id="getPlanNumList" resultType="long">
		SELECT plan_num FROM plan ORDER BY plan_num DESC
	</select>
	
	<select id="getPlanByPlanNum" resultType="com.mit.model.PlanDTO">
		SELECT
			pd.product_num AS productNum
			, pd.product_name AS productName
			, pl.epl_num AS eplNum
			, pl.quantity AS quantity
			, pl.due_date AS dueDate
			, (SELECT ptn_name FROM partner p WHERE p.ptn_num = pd.ptn_num) AS ptnName
			, pd.product_price AS productPrice
			, e.member_id AS memberId
			, e.email AS email
		FROM (plan AS pl INNER JOIN product AS pd ON pl.product_num = pd.product_num)
			LEFT JOIN employee AS e ON pl.epl_num = e.epl_num
		WHERE plan_num = #{ planNum }
	</select>
	
	<select id="getProductList" resultType="com.mit.model.ProductDTO">
		SELECT
			product_num AS productNum
			, ptn_num AS ptnNum
			, product_name AS productName
			, product_price AS productPrice
		FROM product
	</select>
	
	<select id="getProductByProductNum" resultType="com.mit.model.ProductDTO">
		SELECT 
			product_num AS productNum
			, ptn_num AS ptnNum
			, (SELECT ptn_name FROM partner p WHERE p.ptn_num = pd.ptn_num) AS ptnName
			, product_name AS productName
			, product_price AS productPrice
		FROM product AS pd
		WHERE product_num = #{ productNum }
	</select>
	
	<select id="getEmployeeList" resultType="com.mit.model.PlanDTO">
		SELECT
			epl_num AS eplNum
			, member_id AS memberId
			, email AS email
			, (SELECT COUNT(epl_num)
				FROM (SELECT pl.epl_num
						FROM plan AS pl INNER JOIN product AS pd ON pl.product_num = pd.product_num 
						GROUP BY pl.epl_num, pl.due_date, pd.ptn_num
					) AS grp
				WHERE grp.epl_num = e.epl_num
				) AS undertaken
		FROM employee AS e
	</select>
	
	<select id="getCountEmplInPlan" resultType="long">
		SELECT
			COUNT(*)
		FROM plan
		WHERE epl_num = #{ eplNum }
		GROUP BY epl_num;
	</select>
	
	<insert id="insertPlan">
		INSERT INTO plan(epl_num, product_num, quantity, due_date)
		VALUE (#{ eplNum }, #{ productNum }, #{ quantity }, #{ dueDate })
	</insert>
	
	<update id="updatePlan">
		UPDATE plan
		SET epl_num = #{ eplNum }, quantity = #{ quantity }, due_date = #{ dueDate }
		WHERE plan_num = #{ planNum }
	</update>
</mapper>